<!DOCTYPE html>
<html>
<head>
	<title>MUN Helper</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">

	<!-- jQuery library -->
	<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
	<script type="text/javascript" src="script.js"></script>
	<script src="https://cdn.firebase.com/js/client/2.4.0/firebase.js"></script>

	<!-- Latest compiled JavaScript -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
	<style>
		.align_right {
			position: relative;
			padding-right: 10%;
		}
		.align_left{
			position: relative;
			padding-left: 10%;
		}
		h2{
			text-align: center;
			font-size: 100px;

		}
	</style>

</head>
<body>

<script>
var timeoutHandle = null;
var count = -1;
function reset(btnId)
{
	window.clearTimeout(timeoutHandle);
	document.getElementById("startTimer").disabled = false;
	document.getElementById("timerTime").value = "";
	document.getElementById("timerNum").value = "";
	document.getElementById("timer1").value = "MUNHelper";
	count = -1;
	//timeoutHandle =setTimeout(updateTimer, time.getUTCMilliseconds() + 500)
}
function startCountdown(btnId) {
	if(count== "-1"){
		count = document.getElementsByName("numb")[0].value;
	}

	countdown("timer1",btnId, 0, document.getElementsByName("time")[0].value);

	if(document.getElementsByName("time")[0].value != null)
	{
		document.getElementById(btnId).disabled  = false;
	}
	console.log(document.getElementById(btnId));
}

function countdown( elementName, btnId, minutes, seconds ) {
	var element, endTime, hours, mins, msLeft, time;
	console.log("check1");
	console.log("elementName = " + elementName);
	element = document.getElementById( elementName );
	console.log("element = " + element);
	console.log("check2");
	function twoDigits( n )
	{
		return (n <= 9 ? "0" + n : n);
	}
	function updateTimer()
	{
		msLeft = endTime - (+new Date);
		if ( msLeft < 1000 ) {
			element.innerHTML = "0:00";
         	//document.getElementById(btnId).disabled = false; 
         	count--;
         	if(count > 1)
         		element.innerHTML = count + " Speakers Left"
         	else if(count == 0){
         		element.innerHTML = "Reset Timer"
         		document.getElementById("startTimer").disabled = true;

         		window.clearTimeout(timeoutHandle);
     	    	//timeoutHandle
     	    }
     	    else
     	    	element.innerHTML = count + " Speaker Left"
     	 } else {
     	 	time = new Date( msLeft );
     	 	hours = time.getUTCHours();
     	 	mins = time.getUTCMinutes();
     	 	element.innerHTML = (hours ? hours + ':' + twoDigits( mins ) : mins) + ':' + twoDigits( time.getUTCSeconds() );
     	 	timeoutHandle = setTimeout( updateTimer, time.getUTCMilliseconds() + 500 );
     	 }
     	}
     	endTime = (+new Date) + 1000 * (60*minutes + seconds) + 500;
     	updateTimer();
     }

var motions = 2

function elementValue(name) {
	return document.getElementsByName(/*"motion" + motions.toString()*/name)[0].value;
}

function createField() {
	var motionName = "motion" + motions.toString() // Name string based on current number of motions

	var country = elementValue("c-mot-" + motionName)
	var time = elementValue("t-mot-" + motionName)
	var speakers = elementValue("s-mot-" + motionName)
	var topic = elementValue("top-mot-" + motionName)
/*
	"email": localStorage.getItem("email"),
	"password": localStorage.getItem("password")
	}, function(error, authData) {
	if (error) {
	console.log("Login Failed!", error);
	} else {*/
	//console.log("Authenticated successfully with payload:", authData);
	/*
	<li class="list-group-item">
		<input type="text" class="form-control" id="c-mot" name="c-mot-motion0" placeholder="Country">
		<input type="text" class="form-control" id="t-mot" name="t-mot-motion0" placeholder="Time">
		<input type="text" class="form-control" id="s-mot" name="s-mot-motion0" placeholder="# Speakers">
		<input type="text" class="form-control" id="top-mot" name="top-mot-motion0" placeholder="Topic">
		<a class="btn btn-primary" onclick="pass(0);" name="pass-motion0">Pass</a>
	</li>
	*/
	/*firebase.update(data, function(error) {
		if (error) {
			console.log('Synchronization failed');
		} else {*/
			//console.log('Synchronization succeeded');
			motions += 1
			var motionName = "motion" + motions.toString() // Name string based on current number of motions
			console.log("Motion added")

			var listItem = document.createElement("li");
			listItem.className += "list-group-item"
			/*var input = document.createElement("input")
			input.className += "form-control";
			input.type = "text";
			input.id = "cmt" + motions.toString();
			input.name = "motion" + motions.toString();*/

			var countryInput = newInput("c-mot", "c-mot-" + motionName, "Country")
			var timeInput = newInput("t-mot", "t-mot-" + motionName, "Time (Seconds)")
			var speakersInput = newInput("s-mot", "s-mot-" + motionName, "# Speakers")
			var topicInput = newInput("top-mot", "top-mot-" + motionName, "Topic")

			//listItem.appendChild(input);
			listItem.appendChild(countryInput)
			listItem.appendChild(timeInput)
			listItem.appendChild(speakersInput)
			listItem.appendChild(topicInput)

			var passBtn = document.createElement("a")
			passBtn.className = "btn btn-primary"
			passBtn.onclick = "pass(" + motions + ");"
			passBtn.name = "pass-" + motionName
			var text = document.createTextNode("Pass")
			passBtn.appendChild(text)

			listItem.appendChild(passBtn)

			var list = document.getElementsByName("motions-list")[0];
			list.appendChild(listItem);
		//}
	//});
	//}
	//});
}

function newInput(id, name, placeholder) {
	var inputElement = document.createElement("input")
	inputElement.type = "text"
	inputElement.className += "form-control"
	inputElement.id = id
	inputElement.name = name
	inputElement.placeholder = placeholder
	return inputElement
}

var countries = 0;
function createCountry() {
	var firebase = new Firebase("https://munhelper.firebaseio.com/motion-speakers/" + localStorage.getItem("committee-name"));
	var data = {}
	console.log("creating. countries: ", countries)
	if (countries >= 0) {
		data[countries] = document.getElementsByName("speaker" + countries.toString())[0].value;
	}
	/*firebase.authWithPassword({
		"email": localStorage.getItem("email"),
		"password": localStorage.getItem("password")
	}, function(error, authData) {
		if (error) {
			console.log("Login Failed!", error);
		} else {*/
	firebase.update(data, function(error) {
		if (error) {
			console.log('Synchronization failed');
		} else {
			console.log('Synchronization succeeded');
			countries += 1
			console.log("Speaker added")

			var listItem = document.createElement("li");
			listItem.className += "list-group-item"
			listItem.name = "li" + countries.toString();
			console.log("listitem name: ", listItem.name)
			var input = document.createElement("input")
			input.className += "form-control";
			input.type = "text";
			input.id = "cmt" + countries.toString();
			input.name = "speaker" + countries.toString();
			listItem.appendChild(input);
			var list = document.getElementsByName("countries-list")[0];
			list.appendChild(listItem);
		}
	});
		//}
	//});
}

function clearMotions() {
	for(var x = 0; x < 3; x++){
		document.getElementsByName("c-mot-motion" + x)[0].value = "";
		document.getElementsByName("t-mot-motion" + x)[0].value = "";
		document.getElementsByName("s-mot-motion" + x)[0].value = "";
		document.getElementsByName("top-mot-motion" + x)[0].value = "";
	}
}
var triggeredByFirebase = false
function pass(motionNumber) {
	console.log("passing", motionNumber)
	country = document.getElementsByName("c-mot-motion" + motionNumber.toString())[0].value
	time = document.getElementsByName("t-mot-motion" + motionNumber.toString())[0].value
	speakers = document.getElementsByName("s-mot-motion" + motionNumber.toString())[0].value
	topic = document.getElementsByName("top-mot-motion" + motionNumber.toString())[0].value

	// Update motion
	if (!triggeredByFirebase) {
		var firebase = new Firebase("https://munhelper.firebaseio.com/motions/" + localStorage.getItem("committee-name"));
		var data = {}
		var newMotion = {
								"country": country,
								"time": time,
								"speakers": speakers,
								"topic": topic
							}

		data[motionNumber] = newMotion
		firebase.set(data, function(error) {
			if (error) {
			console.log('Synchronization failed');
			} else {
				console.log('Synchronization succeeded');
				console.log("Motion added")
			}
		});
	}

	// Place values in text boxes
	var countryBox = document.getElementsByName("speaker" + countries)[0]
	countryBox.value = country
	if (!triggeredByFirebase) {
		createCountry();
	}

	document.getElementById("timerTime").value = time
	document.getElementById("timerNum").value = speakers
	console.log("topic: " + topic)
}
function clearCountries() {
	var parent = document.getElementsByName("countries-list")[0]
	parent.innerHTML = ''; // Removes all children
	countries = -1;
	console.log("cleared", countries)
	createCountry();
}

$(document).ready(function() {
	var dropdown = document.getElementsByName("acc-drop")[0];
	var name = localStorage.getItem("email")
	if (name == null || name.length == 0) {
		name = "Account"
	};
	dropdown.appendChild(document.createTextNode(" " + name));

	// Populate text fields with data from server
	var firebase = new Firebase("https://munhelper.firebaseio.com/motions/" + localStorage.getItem("committee-name"));
	var element = document.getElementsByName("committee-list")[0];
	firebase.on("value", function(snapshot) {
		console.log("loaded")
		clearMotions();
		clearCountries();
		snapshot.forEach(function(data) {
			console.log(data.key());
			var motionName = "motion" + data.key().toString() // Name string based on current number of motions
			var dict = data.val()

			document.getElementsByName("c-mot-" + motionName)[0].value = dict["country"];
			document.getElementsByName("t-mot-" + motionName)[0].value = dict["speakers"];
			document.getElementsByName("s-mot-" + motionName)[0].value = dict["time"];
			document.getElementsByName("top-mot-" + motionName)[0].value = dict["topic"];

			if (dict["country"] != "" && dict["speakers"] != "" && dict["time"] != "" && dict["topic"] != "") {
				triggeredByFirebase = true;
				pass(parseInt(data.key()));
				triggeredByFirebase = false;
			}
		});
	});
});
</script>
<nav class="navbar navbar-default">
	<div class="container-fluid">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="index.html">MUN Helper</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="inactive"><a href="committees.html">Committees<span class="sr-only">(current)</span></a></li>
			</ul>
			<ul class="nav navbar-nav navbar-right">
				<li class="dropdown">
					<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false" name="acc-drop"><span class="caret"></span></a>
					<ul class="dropdown-menu">
						<li><a href="#">Share This Committee</a></li>
						<li><a href="#">View All Committees</a></li>
						<li><a href="#">View Committee Log</a></li>
						<li role="separator" class="divider"></li>
						<li><a href="#">Log Out</a></li>
					</ul>
				</li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</div><!-- /.container-fluid -->
</nav>
<h2>
	<div id = "timer1">MUNHelper</div>
</h2>
<style type="text/css">
	/* Some custom styles to beautify this example */
	.demo-content{
		padding: 15px;
		font-size: 18px;
		min-height: 300px;
		/*background: #dbdfe5;*/
		margin-bottom: 10px;
	}
	.demo-content.bg-alt{
		/*background: #abb1b8;*/
	}
</style>
<div class="row">
	<div class="col-sm-6">
		<div class="demo-content">
			<div class="col-sm-8">
				<label for="cmt">Motions:</label>
				<ul class="list-group" name="motions-list">
					<li class="list-group-item">
						<input type="text" class="form-control" id="c-mot" name="c-mot-motion0" placeholder="Country">
						<input type="text" class="form-control" id="t-mot" name="t-mot-motion0" placeholder="Time (Seconds)">
						<input type="text" class="form-control" id="s-mot" name="s-mot-motion0" placeholder="# Speakers">
						<input type="text" class="form-control" id="top-mot" name="top-mot-motion0" placeholder="Topic">
						<a class="btn btn-primary" onclick="pass(0);" name="pass-motion0">Pass</a>
					</li>
					<li class="list-group-item">
						<input type="text" class="form-control" id="c-mot" name="c-mot-motion1" placeholder="Country">
						<input type="text" class="form-control" id="t-mot" name="t-mot-motion1" placeholder="Time (Seconds)">
						<input type="text" class="form-control" id="s-mot" name="s-mot-motion1" placeholder="# Speakers">
						<input type="text" class="form-control" id="top-mot" name="top-mot-motion1" placeholder="Topic">
						<a class="btn btn-primary" onclick="pass(1);" name="pass-motion1">Pass</a>
					</li>
					<li class="list-group-item">
						<input type="text" class="form-control" id="c-mot" name="c-mot-motion2" placeholder="Country">
						<input type="text" class="form-control" id="t-mot" name="t-mot-motion2" placeholder="Time (Seconds)">
						<input type="text" class="form-control" id="s-mot" name="s-mot-motion2" placeholder="# Speakers">
						<input type="text" class="form-control" id="top-mot" name="top-mot-motion2" placeholder="Topic">
						<a class="btn btn-primary" onclick="pass(2);" name="pass-motion2">Pass</a>
					</li>
				</ul>
				<a class="btn btn-primary" onclick="createField();" name="create">Add a Motion</a>
				<a class="btn btn-primary" onclick="clearMotions();" name="clear">Clear Motions</a><br><br>
			</div>
			<br>			
		</div>
	</div>
	<div class="col-sm-6">
		<div class="bg-alt">

			<label for="usr">Speaking Time:</label>
			<input type="text" class="form-control" id="timerTime" name="time" placeholder = "(In Seconds)" selected = "selected">
			<label for="usr">Number of Speakers:</label>
			<input type="text" class="form-control" id="timerNum" name="numb" placeholder = "(9/45 = 12 speakers)" selected = "selected"><br>
			<button class="btn btn-primary" id = "startTimer" onclick="startCountdown('button1');" name="submit">Start</button> <button class="btn btn-primary" id = "button2" onclick="reset('button2');" name="submit">Reset</button>
			<br>
			<br>

			<label for="cmt">Speakers:</label>
			<ul class="list-group" name="countries-list">
				<li class="list-group-item" name="li0">
					<input type="text" class="form-control" id="cmt0" name="speaker0" placeholder="Poland">
				</li>
				<!--<li class="list-group-item">
					<input type="text" class="form-control" id="cmt0" name="speaker0" placeholder="Poland">
				</li>
				<li class="list-group-item">
					<input type="text" class="form-control" id="cmt0" name="speaker0" placeholder="Poland">
				</li>-->
			</ul>
			<br>
				<a class="btn btn-primary" onclick="createCountry();" name="create">Add a Country</a>
				<a class="btn btn-primary" onclick="clearCountries();" name="clear">Clear Countries</a><br><br>
		</div>
	</div>
</div>
</body>
</html>